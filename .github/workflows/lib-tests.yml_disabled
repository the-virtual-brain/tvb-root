name: Test lib
on: 
  pull_request:
  push:
jobs:
  lib-tests:
    
    runs-on: self-hosted

    steps:

      - name: nvidia-smi test
        run: nvidia-smi

      - name: pycuda test
        run: python3 -c "import pycuda.autoinit; print('yes')"
      
      - uses: actions/checkout@v3
        with:
            fetch-depth: 0

      - name: put ~/.local/bin on $PATH
        run: echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

      - name: setup env with pipenv
        run: |
          python3 -V
          python3 -m pip install --upgrade pip
          pip3 install pipenv
          cd tvb_library && pipenv install -d --python $(which python3)



      - name: importlib_metadata?
        run: cd tvb_library && pipenv install importlib_metadata

      - name: run library tests
        run: cd tvb_library && pipenv run python3 -m pytest -n12 --ignore=tvb/tests/library/simulator/rateml_test.py

      - name: run library benchmarks
        run: cd tvb_library && pipenv run python3 -m pytest --benchmark-only --ignore=tvb/tests/library/simulator/rateml_test.py
      
      - name: run rateml tests
        run: cd tvb_library && pipenv run bash -c 'pipenv install pycuda && cd tvb/tests/library/simulator/ && pytest rateml_test.py'

      - name: run contrib tests
        run: cd tvb_library && pipenv run bash -c 'pipenv install xarray deprecated && python setup.py develop --no-deps && cd ../tvb_contrib && python3 -m pytest'
